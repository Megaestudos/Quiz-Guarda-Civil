<!-- Index.html ‚Äî Demo server-first (4h), bloqueio definitivo por deviceId, bot√£o pagar -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Quiz Guarda Civil ‚Äî App (Demo)</title>
  <meta name="theme-color" content="#1e3c72"/>
  <style>
    :root{ --bg1:#0f3b6b; --bg2:#1f6fb0; --card-bg: rgba(255,255,255,0.06); --muted: rgba(255,255,255,0.92); --accent: #00ff9d; --card-scale: 1.10; }
    html,body{height:100%;margin:0;padding:0}
    body{ font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background: linear-gradient(135deg,var(--bg1),var(--bg2)); color:#fff; display:flex; align-items:center; justify-content:center; padding:env(safe-area-inset-top) 12px calc(env(safe-area-inset-bottom) + 12px) 12px; }
    .app { width:100%; max-width:920px; display:flex; flex-direction:column; gap:12px; position:relative; }
    .card { background: var(--card-bg); border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,0.28); backdrop-filter: blur(6px); transform: scale(var(--card-scale)); transform-origin: top center; transition: transform .12s ease; }
    .header { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .controls { display:flex; gap:8px; align-items:center; }
    .title { font-size: clamp(18px,4vw,22px); margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:block; }
    .subtitle { font-size:13px; color:#e6f7f0; margin-top:6px; }
    .btn { background:transparent;border:1px solid rgba(255,255,255,0.12); color:#fff;padding:8px 10px;border-radius:10px;font-weight:700; cursor:pointer; }
    .icon-btn { width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:transparent; color:#fff; cursor:pointer; }
    .scale-label { min-width:62px; text-align:center; font-weight:800; }
    .demo-banner { background: rgba(0,0,0,0.2); padding:6px 10px; border-radius:8px; font-weight:800; display:inline-flex; gap:8px; align-items:center; }
    .demo-remaining { font-size:13px; color:#dfffe8; }
    .overlay-lock { position:fixed; inset:0; background:rgba(3,6,12,0.7); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .overlay-card { background:#081a2b; padding:20px; border-radius:12px; box-shadow: 0 8px 30px rgba(0,0,0,0.6); max-width:420px; text-align:center; color:#fff; }
    .overlay-card h2{ margin:0 0 8px 0; }
    .overlay-card p{ margin:8px 0 14px 0; color:#d5f5e7 }
    .overlay-card .linkbtn{ display:inline-block; padding:10px 14px; border-radius:10px; background:linear-gradient(90deg,var(--accent), #2fb6ff); color:#012; font-weight:800; text-decoration:none; }
    @media (max-width:520px){ .controls { flex-wrap:wrap } .title{font-size:16px} }
  </style>
</head>
<body>
  <div class="app" id="appRoot" style="width:100%;max-width:820px;">
    <div class="card header" id="cardHeader">
      <div>
        <h1 class="title">Quiz Guarda Civil üëÆ‚Äç‚ôÇÔ∏è</h1>
        <div class="subtitle">Estude por t√≥picos</div>
      </div>
      <div class="controls">
        <div id="demoBanner" class="demo-banner" style="display:none"><div style="font-size:13px;">DEMO</div><div class="demo-remaining" id="demoRemaining">‚Äî</div></div>
        <button class="icon-btn" id="scaleDownBtn">A‚àí</button>
        <div class="scale-label" id="scaleLabel">x1.10</div>
        <button class="icon-btn" id="scaleUpBtn">A+</button>
        <button class="icon-btn" id="fullscreenBtn">‚õ∂</button>
        <button class="btn" id="soundToggle">üîä Som: On</button>
      </div>
    </div>

    <div class="card pages">
      <section id="home" class="page active">
        <div class="welcome">Ol√°! Escolha um t√≥pico e inicie o quiz quando estiver pronto.</div>
        <div class="home-actions">
          <button class="btn" onclick="go('study')">üìò Estudar</button>
          <button class="btn" onclick="go('quiz')">üéØ Fazer Quiz</button>
          <button class="btn" onclick="go('cards')">üÉè Cart√µes</button>
        </div>
        <div style="margin-top:12px"><div id="bestRecord" class="record">Carregando recorde...</div></div>
      </section>

      <section id="study" class="page"><h3>Conte√∫dos de Estudo</h3><div id="studyList" class="study-list"></div></section>

      <section id="quiz" class="page">
        <div class="topic-select">
          <div class="average">Escolha o T√≥pico:</div>
          <select id="topicSelect"></select>
          <button class="next-btn small-btn" id="loadTopicBtn">Carregar t√≥pico</button>
          <div style="flex:1"></div>
          <div class="small" id="quizNote">Quest√µes por rodada: <strong id="quizSizeLabel"></strong></div>
        </div>
        <div class="progress" style="margin-bottom:8px"><div class="track"><div class="bar" id="bar" style="width:0%"></div></div><div class="small" id="progressInfo">0 / 0</div></div>
        <div class="question" id="question">Aguardando escolha do t√≥pico...</div>
        <div class="opts" id="opts"></div>
        <div class="explain" id="explain" style="display:none"></div>
        <div class="next-area"><div id="progressText" class="small"></div>
          <div style="display:flex;gap:8px">
            <button class="btn" id="btnRestart" onclick="restartQuiz()" style="display:none">üîÑ Reiniciar</button>
            <button class="next-btn" id="nextBtn" disabled>Pr√≥xima ‚ûú</button>
          </div>
        </div>
      </section>

      <section id="cards" class="page"><h3>Cart√µes (clique para virar)</h3><div id="cardsContainer" style="display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin-top:12px;"></div></section>
    </div>

  </div>

<script>
  /* ========== CONFIG ========== */
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyDx-gM1bYrJpcUd16gLfToBEOGJIG0_JlLnpZjKt03yUyWTQ2vAHXhDN9nIWVom9QXJQ/exec'; // atualize se for diferente
  const PURCHASE_URL = 'https://seu-site-de-venda.com/checkout'; // <-- substitua pelo link de compra
  const DEMO_DURATION_HOURS = 4;
  const DEVICE_ID_KEY = 'quiz_device_id';
  const DEMO_LOCAL_KEY = 'quiz_demo_local';
  const TEMPLATE_QUIZ_SIZE = 20;

  /* ===== util ===== */
  function _makeDeviceId(){ return 'dev-' + Date.now() + '-' + Math.random().toString(36).slice(2,10); }
  function pad(n){ return n.toString().padStart(2,'0'); }
  function formatRemaining(ms){ if (ms<=0) return '00:00:00'; const s=Math.floor(ms/1000); const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); const sec=s%60; return `${pad(h)}:${pad(m)}:${pad(sec)}`; }

  async function ensureDeviceId(){ let id = localStorage.getItem(DEVICE_ID_KEY); if (!id){ id = _makeDeviceId(); localStorage.setItem(DEVICE_ID_KEY,id); } return id; }

  /* ===== demo server-first logic ===== */
  async function getDemoStatusServer(deviceId){
    const res = await fetch(`${SCRIPT_URL}?action=getDemoStatus&deviceId=${encodeURIComponent(deviceId)}`, { cache:'no-store' });
    return await res.json();
  }
  async function startDemoServer(deviceId, hours){
    const res = await fetch(`${SCRIPT_URL}?action=startDemo&deviceId=${encodeURIComponent(deviceId)}&durationHours=${Number(hours)}`, { cache:'no-store' });
    return await res.json();
  }

  let demoTimer = null, demoExpiresAt = null, demoLocked=false;

  function showDemoBanner(ms){
    const b = document.getElementById('demoBanner');
    if (!b) return;
    if (ms<=0){ b.style.display='none'; return;}
    b.style.display='inline-flex';
    document.getElementById('demoRemaining').innerText = formatRemaining(ms);
  }

  function setDemoState(expiresIso, source){
    demoExpiresAt = new Date(expiresIso);
    if (demoTimer) clearInterval(demoTimer);
    const tick = ()=>{
      const rem = demoExpiresAt - new Date();
      if (rem <= 0){ clearInterval(demoTimer); demoTimer=null; showDemoBanner(0); lockApp({permanent:false}); return; }
      showDemoBanner(rem);
    };
    tick();
    demoTimer = setInterval(tick,1000);
  }

  function lockApp(opts){
    // opts: { permanent: boolean, title?, message? }
    demoLocked = true;
    if (document.getElementById('overlayLock')) return;
    const permanent = !!(opts && opts.permanent);
    const title = (opts && opts.title) ? opts.title : (permanent ? 'Acesso bloqueado' : 'Demo expirado');
    const msg = (opts && opts.message) ? opts.message : (permanent ? 'A demo j√° foi utilizada neste dispositivo.' : 'Sua sess√£o demo de 4 horas expirou.');
    const overlay = document.createElement('div'); overlay.id='overlayLock'; overlay.className='overlay-lock';
    const card = document.createElement('div'); card.className='overlay-card';
    card.innerHTML = `<h2>${title}</h2><p>${msg}</p>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
        <a id="purchaseBtn" class="linkbtn" href="${PURCHASE_URL}" target="_blank" rel="noopener noreferrer">Acessar vers√£o paga</a>
        ${permanent ? '' : '<a id="tryAgainBtn" class="linkbtn" href="#">Tentar reconectar</a>'}
      </div>`;
    overlay.appendChild(card);
    document.body.appendChild(overlay);
    document.getElementById('appRoot').style.filter='blur(1px)';
    document.querySelectorAll('button,select').forEach(el => el.disabled = true);

    if (!permanent){
      const btn = document.getElementById('tryAgainBtn');
      if (btn) btn.addEventListener('click', (ev)=>{ ev.preventDefault(); overlay.remove(); document.getElementById('appRoot').style.filter=''; document.querySelectorAll('button,select').forEach(el=>el.disabled=false); demoLocked=false; initDemoFlow(); });
    }
  }

  /* ===== core: check/start demo (device-aware) ===== */
  async function initDemoFlow(){
    // server-first, device-aware, and permanent block if device already used
    const deviceId = await ensureDeviceId();
    try {
      const status = await getDemoStatusServer(deviceId);
      if (status && status.ok){
        if (status.demoActive && status.expiresAt){
          setDemoState(status.expiresAt, 'server');
          return;
        }
        // demo not active
        if (status.used){ // server says deviceId already used (even if expired) -> permanent block
          lockApp({permanent:true, title:'Demo j√° utilizada', message:'A demo deste dispositivo j√° foi utilizada. Para continuar, adquira a vers√£o paga.'});
          return;
        }
        // not used => attempt to start demo on server
        const start = await startDemoServer(deviceId, DEMO_DURATION_HOURS);
        if (start && start.ok && (start.expiresAt || start.active)){
          if (start.expiresAt) setDemoState(start.expiresAt, 'server');
          else lockApp({permanent:true, title:'Erro demo', message:'N√£o foi poss√≠vel ativar a demo no servidor.'});
          return;
        }
        // if server said no and didn't provide used flag, treat as not allowed
        if (start && start.used){ lockApp({permanent:true, title:'Demo bloqueada', message:'A demo foi bloqueada para este dispositivo.'}); return; }
      }
    } catch (err){
      console.warn('Servidor demo inacess√≠vel ‚Äî fallback local', err);
      // fallback local: if there is local demo, use it; otherwise create one-time local demo
      const local = JSON.parse(localStorage.getItem(DEMO_LOCAL_KEY) || 'null');
      if (local && local.expiresAt){
        setDemoState(local.expiresAt, 'local');
        return;
      }
      const now = Date.now(); const expires = new Date(now + DEMO_DURATION_HOURS*3600*1000);
      localStorage.setItem(DEMO_LOCAL_KEY, JSON.stringify({startedAt: new Date(now).toISOString(), expiresAt: expires.toISOString()}));
      setDemoState(expires.toISOString(), 'local');
      return;
    }

    // If we reach here, server responded but didn't set demo ‚Äî be conservative and block
    lockApp({permanent:true, title:'Demo indispon√≠vel', message:'A demo n√£o p√¥de ser ativada neste dispositivo. Entre em contato ou adquira a vers√£o paga.'});
  }

  /* ===== page utilities (minimal; quiz code removed for brevity) ===== */
  function go(target){ if (demoLocked) return; document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); const el=document.getElementById(target); if (el) el.classList.add('active'); }
  function restartQuiz(){ /* placeholder */ }

  /* ===== init ===== */
  (function(){
    document.getElementById('quizSizeLabel').innerText = TEMPLATE_QUIZ_SIZE || 20;
    // scale buttons simple
    const SCALE_KEY='quiz_card_scale';
    function readScale(){ const s=parseFloat(localStorage.getItem(SCALE_KEY)); return isNaN(s)?1.1:s; }
    function setScale(v){ document.documentElement.style.setProperty('--card-scale', v); document.getElementById('scaleLabel').innerText='x'+parseFloat(v).toFixed(2); localStorage.setItem(SCALE_KEY, v); }
    setScale(readScale());
    document.getElementById('scaleUpBtn').addEventListener('click', ()=> setScale((readScale()+0.05).toFixed(2)));
    document.getElementById('scaleDownBtn').addEventListener('click', ()=> setScale((readScale()-0.05).toFixed(2)));
    // sound
    const SOUND_KEY='quiz_sound_on';
    if (localStorage.getItem(SOUND_KEY)===null) localStorage.setItem(SOUND_KEY,'1');
    document.getElementById('soundToggle').addEventListener('click', ()=>{ const v = localStorage.getItem(SOUND_KEY)!=='1'; localStorage.setItem(SOUND_KEY, v?'1':'0'); document.getElementById('soundToggle').innerText = v ? 'üîä Som: On' : 'üîá Som: Off'; });
    document.getElementById('soundToggle').innerText = localStorage.getItem(SOUND_KEY)!=='0' ? 'üîä Som: On' : 'üîá Som: Off';

    // Start demo flow
    initDemoFlow();
    // expose debug unlock (remove in prod)
    window.__unlockDemoForDev = function(){ localStorage.removeItem(DEMO_LOCAL_KEY); localStorage.removeItem(DEVICE_ID_KEY); if (document.getElementById('overlayLock')) document.getElementById('overlayLock').remove(); document.getElementById('appRoot').style.filter=''; document.querySelectorAll('button,select').forEach(el=>el.disabled=false); demoLocked=false; initDemoFlow(); };
  })();
</script>
</body>
</html>
